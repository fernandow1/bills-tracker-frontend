<div class="bill-list-container">
  <div class="header">
    <h2>Facturas</h2>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      Nueva Factura
    </button>
  </div>

  <!-- Filtros -->
  <mat-expansion-panel class="filters-panel">
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon>filter_list</mat-icon>
        Filtros de búsqueda
      </mat-panel-title>
    </mat-expansion-panel-header>

    <div class="filters-content">
      <div class="filter-row">
        <mat-form-field appearance="outline">
          <mat-label>Total</mat-label>
          <input matInput type="number" [formControl]="totalControl" placeholder="0.00" />
          <mat-icon matPrefix>attach_money</mat-icon>
        </mat-form-field>
      </div>

      <div class="filter-actions">
        <button mat-button (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Limpiar Filtros
        </button>
        <button mat-raised-button color="accent" (click)="applyFilters()">
          <mat-icon>search</mat-icon>
          Buscar
        </button>
      </div>
    </div>
  </mat-expansion-panel>

  <!-- Tabla -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Cargando facturas...</p>
    </div>
  } @else if (hasError) {
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <p>Error al cargar las facturas. Por favor, intente nuevamente.</p>
        <button mat-raised-button color="primary" (click)="reload()">
          <mat-icon>refresh</mat-icon>
          Reintentar
        </button>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="table-container">
      <div class="table-wrapper">
        <table mat-table [dataSource]="bills" class="bill-table">
          <!-- ID Column -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let element">{{ element.id }}</td>
          </ng-container>

          <!-- Shop Column -->
          <ng-container matColumnDef="shop">
            <th mat-header-cell *matHeaderCellDef>Tienda</th>
            <td mat-cell *matCellDef="let element">
              {{ element.shop.name }}
            </td>
          </ng-container>

          <!-- Total Column -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let element" class="total-cell">
              {{ element.total | currencyFormat: element.currency.symbol }}
            </td>
          </ng-container>

          <!-- Currency Column -->
          <ng-container matColumnDef="currency">
            <th mat-header-cell *matHeaderCellDef>Moneda</th>
            <td mat-cell *matCellDef="let element">
              {{ element.currency.symbol }} ({{ element.currency.code }})
            </td>
          </ng-container>

          <!-- Payment Method Column -->
          <ng-container matColumnDef="paymentMethod">
            <th mat-header-cell *matHeaderCellDef>Método de Pago</th>
            <td mat-cell *matCellDef="let element">
              {{ element.paymentMethod.name }}
            </td>
          </ng-container>

          <!-- Created At Column -->
          <ng-container matColumnDef="purchasedAt">
            <th mat-header-cell *matHeaderCellDef>Fecha</th>
            <td mat-cell *matCellDef="let element">
              {{ element.purchasedAt | date: 'dd/MM/yyyy' }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let element" class="actions-cell">
              <button
                mat-icon-button
                color="primary"
                (click)="openViewDialog(element)"
                matTooltip="Ver detalles"
              >
                <mat-icon>visibility</mat-icon>
              </button>
              <button
                mat-icon-button
                color="accent"
                (click)="openEditDialog(element)"
                matTooltip="Editar"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteBill(element)"
                matTooltip="Eliminar"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>

      <!-- Paginador -->
      <mat-paginator
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="currentPage - 1"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    </div>

    @if (bills.length === 0) {
      <mat-card class="empty-state">
        <mat-card-content>
          <mat-icon>receipt_long</mat-icon>
          <p>No se encontraron facturas</p>
          <button mat-raised-button color="primary" (click)="openCreateDialog()">
            <mat-icon>add</mat-icon>
            Crear Primera Factura
          </button>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
