<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -->
<div class="bill-form-container">
  <div class="dialog-header">
    <h2>{{ title() }}</h2>
    <button mat-icon-button (click)="close()" [disabled]="isLoading">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <form>
    <div class="dialog-content">
      <!-- Información General -->
      <mat-card class="info-card">
        <mat-card-content>
          <h3>Información General</h3>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Fecha de Compra</mat-label>
              <input matInput type="date" [field]="billForm.purchasedAt" />
              <mat-icon matSuffix>event</mat-icon>
            </mat-form-field>
            @if(billForm.purchasedAt().invalid()) { @for (error of billForm.purchasedAt().errors();
            track error) {
            <mat-error>{{ error.message }}</mat-error>
            } }

            <mat-form-field appearance="outline">
              <mat-label>Tienda</mat-label>
              <mat-select [field]="billForm.idShop">
                @for (shop of shops(); track shop.id) {
                <mat-option [value]="shop.id">{{ shop.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            @if(billForm.idShop().invalid()) { @for (error of billForm.idShop().errors(); track
            error) {
            <mat-error>{{ error.message }}</mat-error>
            } }

            <mat-form-field appearance="outline">
              <mat-label>Moneda</mat-label>
              <mat-select [field]="billForm.idCurrency">
                @for (currency of currencies(); track currency.id) {
                <mat-option [value]="currency.id">
                  {{ currency.name }} ({{ currency.code }})
                </mat-option>
                }
              </mat-select>
            </mat-form-field>
            @if(billForm.idCurrency().invalid()) { @for (error of billForm.idCurrency().errors();
            track error) {
            <mat-error>{{ error.message }}</mat-error>
            } }

            <mat-form-field appearance="outline">
              <mat-label>Método de Pago</mat-label>
              <mat-select [field]="billForm.idPaymentMethod">
                @for (method of paymentMethods(); track method.id) {
                <mat-option [value]="method.id">{{ method.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            @if(billForm.idPaymentMethod().invalid()) { @for (error of
            billForm.idPaymentMethod().errors(); track error) {
            <mat-error>{{ error.message }}</mat-error>
            } }
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Items de la Factura -->
      <mat-card class="items-card">
        <mat-card-content>
          <div class="items-header">
            <h3>
              <mat-icon>receipt</mat-icon>
              Items de la Factura
            </h3>
            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="addBillItem()"
              [disabled]="isLoading"
            >
              <mat-icon>add</mat-icon>
              Agregar Item
            </button>
          </div>

          @if (billItems().length > 0) {
          <div class="table-wrapper">
            <table mat-table [dataSource]="billItems()" class="items-table">
              <!-- Product Column -->
              <ng-container matColumnDef="product">
                <th mat-header-cell *matHeaderCellDef>Producto</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <mat-form-field appearance="outline" class="full-width">
                    <input
                      type="text"
                      matInput
                      [value]="getProductForItem(item)?.name || ''"
                      (input)="onProductSearch($any($event.target).value)"
                      [matAutocomplete]="autoProduct"
                      placeholder="Buscar producto..."
                    />
                    <mat-icon matSuffix>search</mat-icon>
                    <mat-autocomplete
                      #autoProduct="matAutocomplete"
                      [displayWith]="displayProduct"
                      (optionSelected)="onProductSelected(i, $event.option.value)"
                    >
                      @for (product of products(); track product.id) {
                      <mat-option [value]="product">
                        <span>{{ product.name }}</span>
                        <small style="color: rgba(0, 0, 0, 0.6); margin-left: 8px">
                          {{ product.brand.name }} - {{ product.category.name }}
                        </small>
                      </mat-option>
                      }
                    </mat-autocomplete>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Brand Column (Read-only) -->
              <ng-container matColumnDef="brand">
                <th mat-header-cell *matHeaderCellDef>Marca</th>
                <td mat-cell *matCellDef="let item">
                  <span class="readonly-field">{{ getProductBrand(item.idProduct) }}</span>
                </td>
              </ng-container>

              <!-- Category Column (Read-only) -->
              <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef>Categoría</th>
                <td mat-cell *matCellDef="let item">
                  <span class="readonly-field">{{ getProductCategory(item.idProduct) }}</span>
                </td>
              </ng-container>

              <!-- Quantity Column -->
              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef class="text-center">Cantidad</th>
                <td mat-cell *matCellDef="let item; let i = index" class="text-center">
                  <mat-form-field appearance="outline" class="small-field">
                    <input
                      matInput
                      type="number"
                      [value]="item.quantity"
                      (blur)="updateItemField(i, 'quantity', +$any($event.target).value)"
                      min="1"
                      step="1"
                    />
                    <mat-error>Requerido</mat-error>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Net Price Column -->
              <ng-container matColumnDef="netPrice">
                <th mat-header-cell *matHeaderCellDef class="text-right">Precio Neto</th>
                <td mat-cell *matCellDef="let item; let i = index" class="text-right">
                  <mat-form-field appearance="outline" class="medium-field">
                    <mat-icon matPrefix>attach_money</mat-icon>
                    <input
                      matInput
                      type="number"
                      [value]="item.netPrice"
                      (blur)="updateItemField(i, 'netPrice', +$any($event.target).value)"
                      min="0"
                      step="0.01"
                    />
                    <mat-error>Requerido</mat-error>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Net Unit Column -->
              <ng-container matColumnDef="netUnit">
                <th mat-header-cell *matHeaderCellDef>Unidad</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <mat-form-field appearance="outline" class="small-field">
                    <mat-select
                      [value]="item.netUnit"
                      (selectionChange)="updateItemField(i, 'netUnit', $event.value)"
                    >
                      <mat-option [value]="NetUnits.UNIT">Unidad</mat-option>
                      <mat-option [value]="NetUnits.GRAM">Gramo</mat-option>
                      <mat-option [value]="NetUnits.KILOGRAM">Kilogramo</mat-option>
                      <mat-option [value]="NetUnits.MILLILITER">Mililitro</mat-option>
                      <mat-option [value]="NetUnits.LITER">Litro</mat-option>
                    </mat-select>
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Subtotal Column -->
              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef class="text-right">Subtotal</th>
                <td mat-cell *matCellDef="let item" class="text-right subtotal-cell">
                  {{ getItemSubtotal(item) | currencyFormat }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="text-center">Acciones</th>
                <td mat-cell *matCellDef="let item; let i = index" class="text-center">
                  <button
                    mat-icon-button
                    color="warn"
                    type="button"
                    (click)="removeBillItem(i)"
                    [disabled]="isLoading"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  let i = index;
                  columns: displayedColumns;
                  trackBy: trackByIndex
                "
                [attr.data-index]="i"
              ></tr>
            </table>
          </div>

          <!-- Total Section -->
          <div class="total-section">
            <span class="total-label">Total de la Factura</span>
            <span class="total-value">{{ total() | currencyFormat }}</span>
          </div>
          } @else {
          <div class="empty-items">
            <mat-icon>inbox</mat-icon>
            <p>No hay items. Haga clic en "Agregar Item" para comenzar.</p>
          </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </form>

  <div class="dialog-actions">
    <button mat-button type="button" (click)="close()" [disabled]="isLoading">
      <mat-icon>close</mat-icon>
      Cancelar
    </button>
    <button
      mat-raised-button
      color="primary"
      type="button"
      (click)="onSubmit()"
      [disabled]="isLoading"
    >
      <mat-icon>{{ isLoading ? 'hourglass_empty' : 'save' }}</mat-icon>
      {{ isLoading ? 'Guardando...' : 'Guardar' }}
    </button>
  </div>
</div>
